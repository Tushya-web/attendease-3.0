{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}AttendEase Admin{% endblock %}

{% block branding %}
<h1 id="site-name"><a href="{% url 'admin:index' %}">AttendEase Admin</a></h1>
{% endblock %}

{% block content %}
<div id="dashboard-container" class="dashboard-container">
  <h2 class="dashboard-title">üìä AttendEase Overview</h2>

  <!-- Summary Cards -->
  <div class="metrics">
    <div class="metric-card student">
      <h3>Total Students</h3>
      <p>{{ total_students }}</p>
    </div>
    <div class="metric-card faculty">
      <h3>Total Faculty</h3>
      <p>{{ total_faculty }}</p>
    </div>
    <div class="metric-card attendance">
      <h3>Today's Attendance</h3>
      <p>{{ today_attendance }}%</p>
    </div>
  </div>

  <!-- Top Users -->
  <div class="charts">
    <div class="chart-card">
      <h4>üèÜ Top 3 Students</h4>
      <ul class="top-list">
        {% for s in top_students %}
        <li>
          {{ s.username }} ‚Äî {{ s.attendance_percent|floatformat:2 }}%
          <div class="progress-bar">
            <div class="fill" style="width: {{ s.attendance_percent }}%;"></div>
          </div>
        </li>
        {% empty %}
        <li>No data</li>
        {% endfor %}
      </ul>

      <h4>üë©‚Äçüè´ Top 3 Faculty</h4>
      <ul class="top-list">
        {% for f in top_faculty %}
        <li>
          {{ f.username }} ‚Äî {{ f.attendance_percent|floatformat:2 }}%
          <div class="progress-bar">
            <div class="fill" style="width: {{ f.attendance_percent }}%;"></div>
          </div>
        </li>
        {% empty %}
        <li>No data</li>
        {% endfor %}
      </ul>
    </div>

    <!-- Monthly Attendance Chart -->
    <div class="chart-card">
      <h4>üìà Monthly Attendance Trend</h4>
      <canvas id="monthlyChart"></canvas>
    </div>
  </div>

  <!-- Low Attendance Users -->
  <div class="graph-box">
    <h3>‚ö† Low Attendance (<75%)</h3>
    <table class="dashboard-table">
      <thead>
        <tr>
          <th>User</th>
          <th>Type</th>
          <th>Attendance %</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for u in low_attendance_users %}
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.user_type }}</td>
          <td>{{ u.attendance_percent|floatformat:2 }}%</td>
          <td>
            <a href="{% url 'admin:accounts_attendance_changelist' %}?user__id__exact={{ u.id }}" class="btn">View Report</a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No low attendance users</td></tr>
        {% endfor %}
      </tbody>
    </table>
    <a href="?export=csv" class="btn export-btn">Export CSV</a>
  </div>
</div>
{% endblock %}

{% block extrastyle %}
<style>
/* Dashboard Containers */
.dashboard-container { padding: 20px; width: 100%; ; background: #f8f6ff; }
.dashboard-title { color: #6f2dbd; font-weight: 700; margin-bottom: 25px; }

/* Metrics Cards */
.metrics { display: flex; gap: 20px; flex-wrap: wrap; }
.metric-card { flex: 1; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(123,44,191,0.15); text-align: center; }
.metric-card h3 { color: #7b2cbf; }
.metric-card p { font-size: 28px; font-weight: bold; color: #5a189a; }

/* Charts */
.charts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
.chart-card { background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 4px 12px rgba(123,44,191,0.15); }
.chart-card h4 { color: #5a189a; font-weight: 600; }

/* Top Users Progress Bars */
.top-list { list-style: none; padding: 0; }
.top-list li { margin-bottom: 10px; font-weight: 500; }
.progress-bar { background: #e5e5e5; border-radius: 10px; height: 10px; width: 100%; margin-top: 5px; }
.fill { background: #7b2cbf; height: 100%; border-radius: 10px; }

/* Low Attendance Table */
.graph-box { margin-top: 30px; background: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(123,44,191,0.15); }
.dashboard-table { width: 100%; border-collapse: collapse; }
.dashboard-table th { background-color:#9333ea; color:white; padding: 8px; text-align: left; }
.dashboard-table td { padding: 8px; border-bottom: 1px solid #ddd; }

/* Buttons */
.btn { background-color: #7b2cbf; color: #fff; padding: 5px 10px; border-radius: 5px; text-decoration: none; font-size: 0.9rem; }
.btn:hover { background-color: #5a189a; }
.export-btn { margin-top: 10px; display: inline-block; }

/* Responsive Styles */
@media (max-width: 768px) {
    /* Dashboard container padding */
    .dashboard-container {
        padding: 15px;
    }

    h2{
      font-size:20px;
    }

    /* Metrics cards stack vertically */
    .metrics {
        flex-direction: column;
        gap: 15px;
    }
    .metric-card {
        flex: 1 1 100%;
        padding: 15px;
    }

    /* Charts stack vertically */
    .charts {
        grid-template-columns: 1fr;
        gap: 15px;
    }

    /* Chart card padding */
    .chart-card {
        padding: 15px;
    }

    /* Table font size smaller */
    .dashboard-table th,
    .dashboard-table td {
        font-size: 0.85rem;
        padding: 6px;
    }

    /* Buttons smaller */
    .btn {
        padding: 4px 8px;
        font-size: 0.8rem;
    }

    /* Top users list smaller */
    .top-list li {
        font-size: 0.85rem;
    }
}

@media (max-width: 480px) {
    /* Further adjustments for small phones */
    
    h2{
      font-size:20px;
    }
    .dashboard-container {
        padding: 10px;
    }
    .metric-card p {
        font-size: 22px;
    }
    .chart-card h4 {
        font-size: 1rem;
    }
    .btn {
        padding: 3px 6px;
        font-size: 0.75rem;
    }
}

</style>
{% endblock %}

{% block extrajs %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('monthlyChart').getContext('2d');
new Chart(ctx, {
    type: 'bar',
    data: {
        labels: {{ months|safe }},
        datasets: [
            { label: 'Students', data: {{ student_counts|safe }}, backgroundColor: 'rgba(123,44,191,0.7)' },
            { label: 'Faculty', data: {{ faculty_counts|safe }}, backgroundColor: 'rgba(57, 123, 255,0.7)' }
        ]
    },
    options: { plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
});
</script>
{% endblock %}
